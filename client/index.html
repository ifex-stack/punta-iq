<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>PuntaIQ Predictions</title>
    <!-- Route Recovery Meta Tag - Helps detect when SPA routes need recovery -->
    <meta name="spa-router" content="enabled">
    <!-- PuntaIQ Configuration & Port Detection Script -->
    <script type="text/javascript">
      // Configure PuntaIQ platform
      window.PuntaIQ = window.PuntaIQ || {};
      
      // Detect when a 404 error page is loaded
      function is404Page() {
        return document.title.includes('404') || 
               document.title.includes('Not Found') ||
               (document.body && document.body.textContent && 
                document.body.textContent.includes('Not Found'));
      }
      
      // Record initial load time to help with diagnostics
      window.PuntaIQ.initialLoadTime = Date.now();
      
      // Function to redirect to the correct application URL  
      function redirectToCorrectUrl() {
        // Redirect logic for Replit environments and localhost
        if (window.location.hostname.includes('.replit.dev') || 
            window.location.hostname === 'localhost' || 
            window.location.hostname.includes('replit.app')) {
            
          // Set the correct API endpoints regardless of port
          window.PuntaIQ.apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;
          window.PuntaIQ.aiServiceBaseUrl = `${window.location.protocol}//${window.location.hostname}:5000`;
          window.PuntaIQ.aiServiceProxyUrl = `${window.location.protocol}//${window.location.hostname}:3000/ai-service`;
          
          console.log(`PuntaIQ configured - API on port 3000, AI service via proxy.`);
          
          // When we're on port 3000, set document.ready flag to help the app know it's ready
          if (window.location.port === '3000') {
            window.PuntaIQ.ready = true;
            console.log('PuntaIQ ready on correct port');
            
            // Attempt SPA route recovery for paths other than root
            if (window.location.pathname !== "/" && window.location.pathname !== "") {
              console.log(`Attempting SPA route recovery for: ${window.location.pathname}`);
              
              // Store the path to help React router pick it up properly
              sessionStorage.setItem('puntaiq_initial_path', window.location.pathname);
              
              // Record route recovery attempt in debugging info
              window.PuntaIQ.routeRecoveryAttempted = true;
              window.PuntaIQ.initialPath = window.location.pathname;
            }
          } else {
            // Only redirect if not already on port 3000
            console.log('Redirecting to port 3000 for PuntaIQ application');
            
            // Preserve path and search params during redirect
            const currentPath = window.location.pathname || '/';
            const currentSearch = window.location.search || '';
            
            // Create the correct URL
            const redirectUrl = `${window.location.protocol}//${window.location.hostname}:3000${currentPath}${currentSearch}`;
            
            console.log(`Redirecting to: ${redirectUrl}`);
            window.location.replace(redirectUrl);
          }
        }
      }
      
      // SPA route recovery - use this when direct URL navigation fails
      function recoverSpaRoute() {
        if (window.location.pathname !== '/' && window.location.pathname !== '') {
          console.log(`Triggering SPA route recovery for: ${window.location.pathname}`);
          
          // Two-step recovery: first go to root to ensure app loads
          if (!window.PuntaIQ.recoveryInProgress) {
            // Mark recovery in progress to prevent loops
            window.PuntaIQ.recoveryInProgress = true;
            
            // Store original path for later recovery
            sessionStorage.setItem('puntaiq_recovery_path', window.location.pathname);
            
            // Navigate to root first to ensure app loads properly
            console.log('Recovery step 1: Navigate to root');
            window.history.pushState(null, '', '/');
            
            // After a delay, attempt to navigate back to the original path
            setTimeout(() => {
              const recoveryPath = sessionStorage.getItem('puntaiq_recovery_path');
              if (recoveryPath) {
                console.log(`Recovery step 2: Navigate to original path: ${recoveryPath}`);
                window.history.pushState(null, '', recoveryPath);
                
                // Fire navigation event to help app detect the change
                const navEvent = new PopStateEvent('popstate');
                window.dispatchEvent(navEvent);
                
                // Clean up
                sessionStorage.removeItem('puntaiq_recovery_path');
                window.PuntaIQ.recoveryComplete = true;
              }
              
              // Reset recovery flag after completion
              window.PuntaIQ.recoveryInProgress = false;
            }, 500);
          }
        }
      }
      
      // Immediate execution
      try {
        redirectToCorrectUrl();
        
        // Enhanced 404 detection and route recovery
        window.addEventListener('DOMContentLoaded', () => {
          if (is404Page()) {
            console.error('404 page detected, attempting recovery...');
            recoverSpaRoute();
          }
          
          // Set up reaction to route changes after the app is loaded
          setTimeout(() => {
            const routeObserver = new MutationObserver((mutations) => {
              for (const mutation of mutations) {
                if (mutation.type === 'childList' && document.title.includes('404')) {
                  console.log('React router 404 detected, attempting recovery...');
                  recoverSpaRoute();
                  break;
                }
              }
            });
            
            // Start observing title changes
            routeObserver.observe(document.querySelector('title'), { childList: true });
          }, 1000);
        });
      } catch (e) {
        console.error('PuntaIQ initialization error:', e);
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- Replit development banner -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>